<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sungabha Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="icon" type="image/png" href="logo1.png">
  <style>
    * { font-family: 'Inter', sans-serif; box-sizing: border-box; }
    html, body { margin: 0; padding: 0; height: 100%; background: #FAFAFA; }
    .glass { backdrop-filter: blur(20px); background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(255, 255, 255, 0.4); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); }
    .glass-dark { backdrop-filter: blur(20px); background: rgba(0, 0, 0, 0.05); border: 1px solid rgba(255, 255, 255, 0.2); }
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #C13584; border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #E1306C; }
    .message-bubble { max-width: 70%; width: fit-content; font-size: 0.95rem; padding: 0.75rem 1.25rem; border-radius: 1rem; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); transition: all 0.2s ease; }
    .message-bubble.sent { background: linear-gradient(45deg, #405DE6, #5851DB, #833AB4, #C13584, #E1306C); color: #FFF; margin-left: auto; border-bottom-right-radius: 0.2rem; }
    .message-bubble.received { background: #EFEFEF; color: #000; margin-right: auto; border-bottom-left-radius: 0.2rem; }
    .message-bubble:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
    .file-message img { max-width: 200px; max-height: 200px; border-radius: 0.5rem; border: 1px solid #DBDBDB; object-fit: cover; }
    .message-actions { display: flex; gap: 0.5rem; margin-top: 0.25rem; background: rgba(255, 255, 255, 0.8); border-radius: 1rem; opacity: 0; pointer-events: none; transform: translateY(5px); transition: all 0.3s ease; width: fit-content; padding: 0.2rem 0.5rem; }
    .message-bubble:hover + .message-actions, .message-actions:hover { opacity: 1; pointer-events: auto; transform: translateY(0); }
    .message-actions.sent { justify-content: flex-end; margin-left: auto; }
    .message-actions.received { justify-content: flex-start; margin-right: auto; }
    .action-icon { cursor: pointer; color: #C13584; font-size: 0.9rem; padding: 0.3rem; border-radius: 50%; transition: all 0.2s ease; }
    .action-icon:hover { background: rgba(193, 53, 132, 0.2); transform: scale(1.1); }
    .settings-toggle { position: relative; display: inline-block; width: 2.5rem; height: 1.25rem; }
    .settings-toggle input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #DBDBDB; transition: 0.3s; border-radius: 1.25rem; }
    .slider:before { content: ""; position: absolute; height: 1rem; width: 1rem; left: 0.125rem; bottom: 0.125rem; background: #FFF; transition: 0.3s; border-radius: 50%; }
    input:checked + .slider { background: #C13584; }
    input:checked + .slider:before { transform: translateX(1.25rem); }
    .toast { position: fixed; bottom: 20px; right: 20px; padding: 12px 20px; border-radius: 8px; color: #FFF; font-size: 14px; z-index: 1000; max-width: 300px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); }
    .toast-success { background: #C13584; }
    .toast-error { background: #E1306C; }
    .modal { transition: opacity 0.3s ease, transform 0.3s ease; transform: scale(0.8); opacity: 0; }
    .modal:not(.hidden) { transform: scale(1); opacity: 1; }
    .nav-icon { transition: all 0.2s ease; }
    .nav-icon.active { background: linear-gradient(45deg, #C13584, #E1306C); color: #FFF; }
    .file-input-label { cursor: pointer; }
    .file-input-label:hover { background: rgba(193, 53, 132, 0.2); }
    .profile-img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; }
    .status-online { background: #22C55E; }
    .status-offline { background: #DBDBDB; }
    .user-info { display: flex; flex-direction: column; justify-content: center; flex: 1; min-width: 0; }
    .reaction-count { background: rgba(255, 255, 255, 0.9); border-radius: 1rem; padding: 0.25rem 0.5rem; font-size: 0.8rem; color: #262626; }
    .image-link { display: block; }
    .instagram-bg { background: #FFF; }
    .instagram-header { background: linear-gradient(45deg, #405DE6, #5851DB, #833AB4, #C13584, #E1306C); color: #FFF; }
    .instagram-input { background: #FAFAFA; border: 1px solid #DBDBDB; border-radius: 0.5rem; }
    .private-chat-list-item { margin-bottom: 0.75rem; padding: 0.75rem; }
    .instagram-profile { max-width: 500px; margin: auto; padding: 2rem; background: #FFF; border-radius: 1rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
    .profile-header { background: linear-gradient(45deg, #405DE6, #5851DB, #833AB4, #C13584, #E1306C); padding: 1rem; border-radius: 0.5rem 0.5rem 0 0; }
    @media (min-width: 1024px) {
      .message-bubble { max-width: 65%; }
      .file-message img { max-width: 250px; max-height: 250px; }
      .instagram-profile { max-width: 600px; }
    }
    @media (max-width: 640px) {
      .message-bubble { max-width: 85%; font-size: 0.9rem; padding: 0.5rem 1rem; }
      .file-message img { max-width: 150px; max-height: 150px; }
      #groupChatMessages, #privateChatMessages { padding-bottom: 5rem; }
      .profile-img { width: 32px; height: 32px; }
      .instagram-profile { padding: 1rem; }
    }
  </style>
</head>
<body class="bg-[#FAFAFA]">
  <!-- Home Screen (Login/Signup) -->
  <div id="homeScreen" class="min-h-screen flex items-center justify-center p-4 bg-[#FAFAFA]">
    <div class="glass rounded-2xl p-6 w-full max-w-sm md:max-w-md shadow-lg">
      <div class="text-center mb-6">
        <img src="logo1.png" alt="Logo" class="w-12 h-12 mx-auto mb-4 rounded-full shadow-md">
        <h1 class="text-2xl font-bold text-[#262626]">Sungabha Chat</h1>
      </div>
      <div class="space-y-4">
        <div id="nameWrapper" class="relative">
          <input id="usernameInput" type="text" placeholder="Enter your name" class="w-full px-10 py-3 rounded-lg instagram-input text-[#262626] focus:border-[#C13584] text-sm" maxlength="30">
          <i class="fas fa-user absolute left-4 top-1/2 transform -translate-y-1/2 text-[#8E8E8E]"></i>
        </div>
        <div class="relative">
          <input id="emailInput" type="email" placeholder="Enter your email" class="w-full px-10 py-3 rounded-lg instagram-input text-[#262626] focus:border-[#C13584] text-sm">
          <i class="fas fa-envelope absolute left-4 top-1/2 transform -translate-y-1/2 text-[#8E8E8E]"></i>
        </div>
        <div class="relative">
          <input id="passwordInput" type="password" placeholder="Enter your password" class="w-full px-10 py-3 rounded-lg instagram-input text-[#262626] focus:border-[#C13584] text-sm" minlength="6">
          <i class="fas fa-lock absolute left-4 top-1/2 transform -translate-y-1/2 text-[#8E8E8E]"></i>
          <i id="passwordToggle" class="fas fa-eye absolute right-4 top-1/2 transform -translate-y-1/2 text-[#8E8E8E] cursor-pointer hover:text-[#C13584] p-2"></i>
        </div>
        <button id="authBtn" class="w-full bg-gradient-to-r from-[#C13584] to-[#E1306C] text-white font-semibold py-3 rounded-lg hover:opacity-90 text-sm">
          <i class="fas fa-rocket mr-2"></i>Create Account
        </button>
        <p id="toggleAuth" class="text-center text-[#8E8E8E] cursor-pointer text-xs hover:text-[#C13584]">Already have an account? Sign In</p>
        <button id="googleBtn" class="w-full bg-[#FAFAFA] border border-[#DBDBDB] text-[#262626] font-semibold py-3 rounded-lg hover:bg-[#EFEFEF] text-sm flex items-center justify-center">
          <i class="fab fa-google mr-2 text-[#C13584]"></i>Sign in with Google
        </button>
        <p id="authMessage" class="text-center text-xs mt-4 hidden p-3 rounded-lg"></p>
      </div>
    </div>
  </div>

  <!-- Verification Screen -->
  <div id="verificationScreen" class="hidden min-h-screen flex items-center justify-center p-4 bg-[#FAFAFA]">
    <div class="glass rounded-2xl p-6 w-full max-w-sm md:max-w-md shadow-lg text-center">
      <h2 class="text-2xl font-bold text-[#262626] mb-4">Verify Your Email</h2>
      <p class="text-[#8E8E8E] mb-6 text-sm">We have sent a verification email to your account.</p>
      <button id="resendBtn" class="w-full bg-gradient-to-r from-[#C13584] to-[#E1306C] text-white py-3 rounded-lg hover:opacity-90 text-sm">
        <i class="fas fa-paper-plane mr-2"></i>Resend Verification Email
      </button>
      <button id="backToLoginBtn" class="w-full bg-[#EFEFEF] text-[#262626] py-3 rounded-lg hover:bg-[#DBDBDB] text-sm mt-3">
        <i class="fas fa-arrow-left mr-2"></i>Back to Login
      </button>
      <p id="verificationMessage" class="text-center text-xs mt-4 hidden p-3 rounded-lg"></p>
    </div>
  </div>

  <!-- Main App Container -->
  <div id="appContainer" class="hidden h-screen flex flex-col bg-[#FAFAFA]">
    <!-- Group Chat Page -->
    <div id="groupChatPage" class="flex-1 flex flex-col hidden instagram-bg">
      <div class="sticky top-0 z-20 instagram-header p-4 flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <img src="logo1.png" alt="Logo" class="w-10 h-10 rounded-full shadow-md">
          <div>
            <h2 id="groupChatTitle" class="font-bold text-white text-lg">Sungabha Group Chat</h2>
            <div id="activeUsersCount" class="text-sm text-white/80 flex items-center">
              <div class="w-2 h-2 bg-[#22C55E] rounded-full animate-pulse mr-2"></div>
              <span id="userCount">0</span> users online
            </div>
          </div>
        </div>
        <button id="showUsersBtn" class="p-2 hover:bg-[#FFFFFF]/20 rounded-full">
          <i class="fas fa-cog text-white"></i>
        </button>
      </div>
      <div id="groupPinnedMessages" class="glass-dark mx-4 mt-2 p-3 rounded-lg hidden"></div>
      <div id="groupReplyPreview" class="hidden mx-4 mb-2 p-3 glass rounded-lg flex items-center justify-between">
        <span class="text-[#262626] text-sm">Replying to: <span id="groupReplyText" class="font-medium"></span></span>
        <button id="groupCancelReply" class="text-[#E1306C] hover:text-[#C13584]"><i class="fas fa-times"></i></button>
      </div>
      <div id="groupChatMessages" class="flex-1 overflow-y-auto p-4 custom-scrollbar instagram-bg pb-20"></div>
      <div class="sticky bottom-14 bg-[#FAFAFA] border-t border-[#DBDBDB] p-4 z-20 flex items-center gap-2">
        <label class="file-input-label p-3 rounded-full hover:bg-[#EFEFEF]">
          <i class="fas fa-paperclip text-[#262626] text-lg"></i>
          <input id="groupFileInput" type="file" accept="image/*" class="hidden">
        </label>
        <input type="text" id="groupMessageInput" placeholder="Type a message..." class="flex-1 px-4 py-3 rounded-lg instagram-input text-[#262626] focus:border-[#C13584] text-sm" maxlength="1000">
        <button id="groupSendBtn" class="bg-gradient-to-r from-[#C13584] to-[#E1306C] text-white w-12 h-12 rounded-full flex items-center justify-center hover:opacity-90">
          <i class="fas fa-paper-plane text-lg"></i>
        </button>
      </div>
    </div>

    <!-- Private Chat Page -->
    <div id="privateChatPage" class="flex-1 flex flex-col hidden instagram-bg">
      <div class="sticky top-0 z-20 instagram-header p-4 flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <button id="backToPrivateList" class="p-2 hover:bg-[#FFFFFF]/20 rounded-full">
            <i class="fas fa-arrow-left text-white"></i>
          </button>
          <img id="privateProfileImg" src="https://via.placeholder.com/40" alt="Profile" class="w-10 h-10 rounded-full">
          <div>
            <h2 id="privateChatTitle" class="font-bold text-white text-lg">Private Chats</h2>
            <p id="privateOnlineStatus" class="text-sm text-white/80"></p>
          </div>
        </div>
      </div>
      <div id="privatePinnedMessages" class="glass-dark mx-4 mt-2 p-3 rounded-lg hidden"></div>
      <div id="privateReplyPreview" class="hidden mx-4 mb-2 p-3 glass rounded-lg flex items-center justify-between">
        <span class="text-[#262626] text-sm">Replying to: <span id="privateReplyText" class="font-medium"></span></span>
        <button id="privateCancelReply" class="text-[#E1306C] hover:text-[#C13584]"><i class="fas fa-times"></i></button>
      </div>
      <div id="privateChatList" class="flex-1 overflow-y-auto p-4 custom-scrollbar instagram-bg"></div>
      <div id="privateChatMessages" class="flex-1 overflow-y-auto p-4 custom-scrollbar instagram-bg hidden pb-20"></div>
      <div id="privateMessageInputContainer" class="sticky bottom-14 bg-[#FAFAFA] border-t border-[#DBDBDB] p-4 z-20 flex items-center gap-2 hidden">
        <label class="file-input-label p-3 rounded-full hover:bg-[#EFEFEF]">
          <i class="fas fa-paperclip text-[#262626] text-lg"></i>
          <input id="privateFileInput" type="file" accept="image/*" class="hidden">
        </label>
        <input type="text" id="privateMessageInput" placeholder="Type a message..." class="flex-1 px-4 py-3 rounded-lg instagram-input text-[#262626] focus:border-[#C13584] text-sm" maxlength="1000">
        <button id="privateSendBtn" class="bg-gradient-to-r from-[#C13584] to-[#E1306C] text-white w-12 h-12 rounded-full flex items-center justify-center hover:opacity-90">
          <i class="fas fa-paper-plane text-lg"></i>
        </button>
      </div>
    </div>

    <!-- Settings Page -->
    <div id="settingsPage" class="flex-1 flex flex-col hidden instagram-bg">
      <div class="instagram-profile">
        <div class="profile-header">
          <h2 class="text-xl font-bold text-white text-center">Profile</h2>
        </div>
        <div class="p-6">
          <div class="flex flex-col items-center mb-6">
            <img id="profileImg" src="https://via.placeholder.com/150" alt="Profile" class="w-24 h-24 rounded-full border-4 border-[#C13584] mb-4 shadow-md">
            <input id="newNameInput" type="text" placeholder="Display name" class="text-center text-lg font-semibold w-full mb-3 border-b border-[#DBDBDB] focus:border-[#C13584] outline-none bg-transparent text-[#262626]" maxlength="30">
            <textarea id="bioInput" placeholder="Your bio" class="text-center text-sm w-full mb-4 border-b border-[#DBDBDB] focus:border-[#C13584] outline-none bg-transparent text-[#262626]" maxlength="150"></textarea>
            <label class="file-input-label p-2 rounded-full bg-gradient-to-r from-[#C13584] to-[#E1306C] text-white hover:opacity-90 cursor-pointer">
              <i class="fas fa-camera"></i>
              <input id="profileImgInput" type="file" accept="image/*" class="hidden">
            </label>
          </div>
          <div class="space-y-4">
            <div class="flex items-center justify-between">
              <span class="text-sm text-[#262626]">Sound Notifications</span>
              <label class="settings-toggle">
                <input id="soundToggle" type="checkbox" checked>
                <span class="slider"></span>
              </label>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-sm text-[#262626]">Auto-scroll</span>
              <label class="settings-toggle">
                <input id="autoScrollToggle" type="checkbox" checked>
                <span class="slider"></span>
              </label>
            </div>
            <button id="saveProfileBtn" class="w-full bg-gradient-to-r from-[#C13584] to-[#E1306C] text-white py-3 rounded-lg hover:opacity-90 text-sm">Save Profile</button>
            <button id="logoutBtn" class="w-full bg-[#EFEFEF] text-[#E1306C] py-3 rounded-lg hover:bg-[#DBDBDB] text-sm">
              <i class="fas fa-sign-out-alt mr-2"></i>Logout
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="fixed bottom-0 left-0 right-0 bg-[#FAFAFA] border-t border-[#DBDBDB] p-2 flex justify-around z-30">
      <button id="navGroupChat" class="nav-icon p-3 rounded-full hover:bg-[#EFEFEF]">
        <i class="fas fa-users text-[#262626] text-lg"></i>
      </button>
      <button id="navPrivateChat" class="nav-icon p-3 rounded-full hover:bg-[#EFEFEF]">
        <i class="fas fa-user text-[#262626] text-lg"></i>
      </button>
      <button id="navSettings" class="nav-icon p-3 rounded-full hover:bg-[#EFEFEF]">
        <i class="fas fa-cog text-[#262626] text-lg"></i>
      </button>
    </div>

    <!-- Reaction Modal -->
    <div id="reactionModal" class="hidden fixed inset-0 bg-[#000000]/50 flex items-center justify-center z-50">
      <div class="glass rounded-2xl p-6 w-full max-w-[320px]">
        <h3 class="font-bold text-xl text-[#262626] mb-4 text-center">Choose Reaction</h3>
        <div class="flex gap-4 justify-center mb-4 flex-wrap">
          <button class="reaction-btn text-2xl p-3 rounded-full hover:bg-[#EFEFEF]" data-reaction="üëç">üëç</button>
          <button class="reaction-btn text-2xl p-3 rounded-full hover:bg-[#EFEFEF]" data-reaction="‚ù§Ô∏è">‚ù§Ô∏è</button>
          <button class="reaction-btn text-2xl p-3 rounded-full hover:bg-[#EFEFEF]" data-reaction="üòÇ">üòÇ</button>
          <button class="reaction-btn text-2xl p-3 rounded-full hover:bg-[#EFEFEF]" data-reaction="üò¢">üò¢</button>
          <button class="reaction-btn text-2xl p-3 rounded-full hover:bg-[#EFEFEF]" data-reaction="üò°">üò°</button>
          <button class="reaction-btn text-2xl p-3 rounded-full hover:bg-[#EFEFEF]" data-reaction="üî•">üî•</button>
          <button class="reaction-btn text-2xl p-3 rounded-full hover:bg-[#EFEFEF]" data-reaction="üòç">üòç</button>
          <button class="reaction-btn text-2xl p-3 rounded-full hover:bg-[#EFEFEF]" data-reaction="üôå">üôå</button>
        </div>
        <button id="closeReactionModal" class="py-2 px-6 rounded-lg border border-[#DBDBDB] text-[#262626] hover:bg-[#EFEFEF] text-sm">Cancel</button>
      </div>
    </div>

    <!-- Group Settings Modal -->
    <div id="groupSettingsModal" class="hidden fixed inset-0 bg-[#000000]/50 flex items-center justify-center z-50">
      <div class="glass rounded-2xl p-6 w-full max-w-[320px]">
        <h3 class="font-bold text-xl text-[#262626] mb-4 text-center">Group Settings</h3>
        <input id="groupNameInput" type="text" placeholder="Group Name" class="w-full px-4 py-2 rounded-lg instagram-input text-[#262626] mb-3 text-sm">
        <textarea id="groupDescInput" placeholder="Group Description" class="w-full px-4 py-2 rounded-lg instagram-input text-[#262626] mb-3 text-sm" maxlength="200"></textarea>
        <button id="saveGroupBtn" class="w-full bg-gradient-to-r from-[#C13584] to-[#E1306C] text-white py-2 rounded-lg hover:opacity-90 text-sm">Save Changes</button>
        <button id="deleteChatBtn" class="w-full bg-[#EFEFEF] text-[#E1306C] py-2 rounded-lg hover:bg-[#DBDBDB] text-sm mt-2">Delete All Chat</button>
        <button id="exportChatBtn" class="w-full bg-[#EFEFEF] text-[#E1306C] py-2 rounded-lg hover:bg-[#DBDBDB] text-sm mt-2">Export Chat</button>
        <button id="closeGroupSettingsBtn" class="w-full bg-[#EFEFEF] text-[#262626] py-2 rounded-lg hover:bg-[#DBDBDB] text-sm mt-2">Close</button>
      </div>
    </div>

    <!-- JavaScript -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getDatabase, ref, set, push, onValue, onDisconnect, serverTimestamp, get, update, remove, onChildAdded } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
      import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendEmailVerification, updateProfile, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCoKAoarWlu8B6cnIw549hfg_UPe8YRSko",
        authDomain: "nepchat-aac9d.firebaseapp.com",
        databaseURL: "https://nepchat-aac9d-default-rtdb.firebaseio.com",
        projectId: "nepchat-aac9d",
        storageBucket: "nepchat-aac9d.firebasestorage.app",
        messagingSenderId: "179485804786",
        appId: "1:179485804786:web:3ec8a2fc563b08c682286b"
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      const auth = getAuth(app);
      const IMGBB_API_KEY = "fdeb5290f70387fcaabd7fb9fbe6d6ca";

      let currentUser = null, currentDisplayName = null, currentUsername = null, currentChatType = 'group', currentChatId = null, replyToId = null, reactionMessageId = null;
      const settings = JSON.parse(localStorage.getItem('chatSettings')) || { soundNotifications: true, autoScroll: true };
      let userCache = {};
      let groupStartTime = 0;
      let privateStartTime = 0;

      const sendSound = new Audio('https://notificationsounds.com/storage/sounds/file-sounds-1151-definite.mp3');
      const receiveSound = new Audio('https://notificationsounds.com/storage/sounds/file-sounds-1148-sms-alert-5.mp3');

      // DOM Elements
      const homeScreen = document.getElementById('homeScreen');
      const verificationScreen = document.getElementById('verificationScreen');
      const appContainer = document.getElementById('appContainer');
      const groupChatPage = document.getElementById('groupChatPage');
      const privateChatPage = document.getElementById('privateChatPage');
      const settingsPage = document.getElementById('settingsPage');
      const usernameInput = document.getElementById('usernameInput');
      const emailInput = document.getElementById('emailInput');
      const passwordInput = document.getElementById('passwordInput');
      const passwordToggle = document.getElementById('passwordToggle');
      const authBtn = document.getElementById('authBtn');
      const toggleAuth = document.getElementById('toggleAuth');
      const googleBtn = document.getElementById('googleBtn');
      const authMessage = document.getElementById('authMessage');
      const resendBtn = document.getElementById('resendBtn');
      const backToLoginBtn = document.getElementById('backToLoginBtn');
      const verificationMessage = document.getElementById('verificationMessage');
      const groupMessageInput = document.getElementById('groupMessageInput');
      const groupSendBtn = document.getElementById('groupSendBtn');
      const groupFileInput = document.getElementById('groupFileInput');
      const groupReplyPreview = document.getElementById('groupReplyPreview');
      const groupReplyText = document.getElementById('groupReplyText');
      const groupCancelReply = document.getElementById('groupCancelReply');
      const groupPinnedMessages = document.getElementById('groupPinnedMessages');
      const privateMessageInput = document.getElementById('privateMessageInput');
      const privateSendBtn = document.getElementById('privateSendBtn');
      const privateFileInput = document.getElementById('privateFileInput');
      const privateReplyPreview = document.getElementById('privateReplyPreview');
      const privateReplyText = document.getElementById('privateReplyText');
      const privateCancelReply = document.getElementById('privateCancelReply');
      const privatePinnedMessages = document.getElementById('privatePinnedMessages');
      const privateChatList = document.getElementById('privateChatList');
      const privateChatMessages = document.getElementById('privateChatMessages');
      const privateMessageInputContainer = document.getElementById('privateMessageInputContainer');
      const backToPrivateList = document.getElementById('backToPrivateList');
      const privateChatTitle = document.getElementById('privateChatTitle');
      const privateOnlineStatus = document.getElementById('privateOnlineStatus');
      const privateProfileImg = document.getElementById('privateProfileImg');
      const navGroupChat = document.getElementById('navGroupChat');
      const navPrivateChat = document.getElementById('navPrivateChat');
      const navSettings = document.getElementById('navSettings');
      const showUsersBtn = document.getElementById('showUsersBtn');
      const soundToggle = document.getElementById('soundToggle');
      const autoScrollToggle = document.getElementById('autoScrollToggle');
      const newNameInput = document.getElementById('newNameInput');
      const bioInput = document.getElementById('bioInput');
      const profileImgInput = document.getElementById('profileImgInput');
      const profileImg = document.getElementById('profileImg');
      const saveProfileBtn = document.getElementById('saveProfileBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      const reactionModal = document.getElementById('reactionModal');
      const closeReactionModal = document.getElementById('closeReactionModal');
      const groupSettingsModal = document.getElementById('groupSettingsModal');
      const groupNameInput = document.getElementById('groupNameInput');
      const groupDescInput = document.getElementById('groupDescInput');
      const saveGroupBtn = document.getElementById('saveGroupBtn');
      const deleteChatBtn = document.getElementById('deleteChatBtn');
      const exportChatBtn = document.getElementById('exportChatBtn');
      const closeGroupSettingsBtn = document.getElementById('closeGroupSettingsBtn');
      let isSignUp = true;

      // Log DOM elements to verify they exist
      console.log('DOM Elements Loaded:', {
        authBtn: !!authBtn,
        googleBtn: !!googleBtn,
        toggleAuth: !!toggleAuth,
        passwordToggle: !!passwordToggle,
        closeGroupSettingsBtn: !!closeGroupSettingsBtn
      });

      // Utility Functions
      function sanitizeUsername(username) {
        return username.replace(/[.#$[\]]/g, '_').toLowerCase();
      }

      function showAuthMessage(message, isError) {
        authMessage.textContent = message;
        authMessage.className = `text-center text-xs mt-4 p-3 rounded-lg ${isError ? 'bg-[#E1306C] text-white' : 'bg-[#C13584] text-white'}`;
        authMessage.classList.remove('hidden');
        setTimeout(() => authMessage.classList.add('hidden'), 5000);
      }

      function showVerificationMessage(message, isError) {
        verificationMessage.textContent = message;
        verificationMessage.className = `text-center text-xs mt-4 p-3 rounded-lg ${isError ? 'bg-[#E1306C] text-white' : 'bg-[#C13584] text-white'}`;
        verificationMessage.classList.remove('hidden');
        setTimeout(() => verificationMessage.classList.add('hidden'), isError ? 5000 : 8000);
      }

      function showTemporarySuccess(message) {
        const toast = document.createElement('div');
        toast.className = 'toast toast-success';
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      }

      function showTemporaryError(message) {
        const toast = document.createElement('div');
        toast.className = 'toast toast-error';
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      }

      function escapeHtml(unsafe) {
        return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
      }

      // Authentication Functions
      async function handleAuth() {
        console.log('handleAuth called, isSignUp:', isSignUp);
        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();
        if (!email.includes('@') || !email.includes('.')) {
          showAuthMessage('Please enter a valid email address', true);
          return;
        }
        if (password.length < 6) {
          showAuthMessage('Password must be at least 6 characters', true);
          return;
        }
        authBtn.disabled = true;
        try {
          if (isSignUp) {
            const name = usernameInput.value.trim();
            if (!name) {
              showAuthMessage('Please enter your name', true);
              return;
            }
            console.log('Creating user with email:', email);
            const { user } = await createUserWithEmailAndPassword(auth, email, password);
            console.log('User created:', user.uid);
            await updateProfile(user, { displayName: name });
            await set(ref(db, `usernames/${sanitizeUsername(email.split('@')[0])}`), {
              uid: user.uid,
              email,
              displayName: name,
              profileImg: 'https://via.placeholder.com/64',
              bio: ''
            });
            await sendEmailVerification(user);
            showVerificationScreen(email);
          } else {
            console.log('Signing in with email:', email);
            await signInWithEmailAndPassword(auth, email, password);
            console.log('Sign in successful');
          }
        } catch (error) {
          console.error('Authentication error:', error.code, error.message);
          const errorMessages = {
            'auth/email-already-in-use': 'Email is already registered',
            'auth/invalid-email': 'Invalid email format',
            'auth/user-not-found': 'No account found with this email',
            'auth/wrong-password': 'Incorrect password',
            'auth/too-many-requests': 'Too many attempts, please try again later',
            'auth/network-request-failed': 'Network error, please check your connection'
          };
          showAuthMessage(errorMessages[error.code] || error.message, true);
        } finally {
          authBtn.disabled = false;
        }
      }

      async function signInWithGoogle() {
        console.log('signInWithGoogle called');
        googleBtn.disabled = true;
        try {
          const provider = new GoogleAuthProvider();
          console.log('Attempting Google sign-in');
          const { user } = await signInWithPopup(auth, provider);
          console.log('Google sign-in successful:', user.uid);
          const username = sanitizeUsername(user.email.split('@')[0]);
          const userSnap = await get(ref(db, `usernames/${username}`));
          if (!userSnap.exists()) {
            await set(ref(db, `usernames/${username}`), {
              uid: user.uid,
              email: user.email,
              displayName: user.displayName || user.email.split('@')[0],
              profileImg: user.photoURL || 'https://via.placeholder.com/64',
              bio: ''
            });
            console.log('New user profile created for:', username);
          }
          showAuthMessage('Signed in with Google', false);
        } catch (error) {
          console.error('Google sign-in error:', error.code, error.message);
          const errorMessages = {
            'auth/popup-closed-by-user': 'Google sign-in cancelled',
            'auth/network-request-failed': 'Network error, please check your connection'
          };
          showAuthMessage(errorMessages[error.code] || error.message, true);
        } finally {
          googleBtn.disabled = false;
        }
      }

      async function resendVerification() {
        console.log('resendVerification called');
        if (!auth.currentUser) {
          showVerificationMessage('Please sign in first', true);
          return;
        }
        resendBtn.disabled = true;
        try {
          console.log('Resending verification email to:', auth.currentUser.email);
          await sendEmailVerification(auth.currentUser);
          showVerificationMessage('Verification email sent', false);
        } catch (error) {
          console.error('Resend verification error:', error.code, error.message);
          showVerificationMessage(error.message, true);
        } finally {
          resendBtn.disabled = false;
        }
      }

      async function backToLogin() {
        console.log('backToLogin called');
        verificationScreen.classList.add('hidden');
        homeScreen.classList.remove('hidden');
        usernameInput.value = '';
        emailInput.value = '';
        passwordInput.value = '';
        authMessage.classList.add('hidden');
        verificationMessage.classList.add('hidden');
        if (auth.currentUser) {
          await signOut(auth);
          console.log('User signed out');
        }
      }

      function showVerificationScreen(email) {
        console.log('showVerificationScreen called for:', email);
        homeScreen.classList.add('hidden');
        verificationScreen.classList.remove('hidden');
        appContainer.classList.add('hidden');
        showVerificationMessage(`Verification email sent to ${email}. Please check your inbox and spam folder.`, false);
      }

      function showHomeScreen() {
        console.log('showHomeScreen called');
        homeScreen.classList.remove('hidden');
        verificationScreen.classList.add('hidden');
        appContainer.classList.add('hidden');
      }

      function showAppContainer() {
        console.log('showAppContainer called');
        homeScreen.classList.add('hidden');
        verificationScreen.classList.add('hidden');
        appContainer.classList.remove('hidden');
        switchPage('group');
      }

      // Navigation
      function switchPage(page) {
        console.log('switchPage called:', page);
        groupChatPage.classList.add('hidden');
        privateChatPage.classList.add('hidden');
        settingsPage.classList.add('hidden');
        navGroupChat.classList.remove('active');
        navPrivateChat.classList.remove('active');
        navSettings.classList.remove('active');

        if (page === 'group') {
          groupChatPage.classList.remove('hidden');
          navGroupChat.classList.add('active');
          currentChatType = 'group';
          currentChatId = null;
          groupStartTime = Date.now();
          loadMessages('messages', groupChatMessages);
          updatePinnedMessages('messages', groupPinnedMessages);
          markAllAsRead('messages');
          const groupMessagesRef = ref(db, 'messages');
          onChildAdded(groupMessagesRef, (snap) => {
            const msg = snap.val();
            if (msg.timestamp > groupStartTime && msg.uid !== currentUser.uid && settings.soundNotifications) {
              receiveSound.play();
            }
          });
        } else if (page === 'private') {
          privateChatPage.classList.remove('hidden');
          navPrivateChat.classList.add('active');
          showPrivateChatList();
        } else if (page === 'settings') {
          settingsPage.classList.remove('hidden');
          navSettings.classList.add('active');
          loadProfile();
        }
      }

      // Profile Management
      async function loadProfile() {
        console.log('loadProfile called for:', currentUsername);
        try {
          const userSnap = await get(ref(db, `usernames/${currentUsername}`));
          const userData = userSnap.val();
          if (userData) {
            newNameInput.value = userData.displayName || '';
            bioInput.value = userData.bio || '';
            profileImg.src = userData.profileImg || 'https://via.placeholder.com/64';
          }
        } catch (error) {
          console.error('Failed to load profile:', error);
          showTemporaryError('Failed to load profile');
        }
      }

      async function handleProfileImgUpload(event) {
        console.log('handleProfileImgUpload called');
        const file = event.target.files[0];
        if (!file) return;
        if (file.size > 32 * 1024 * 1024) {
          showTemporaryError('Profile image size exceeds 32MB limit');
          return;
        }
        if (!file.type.startsWith('image/')) {
          showTemporaryError('Please select an image file');
          return;
        }

        const formData = new FormData();
        formData.append('image', file);
        formData.append('key', IMGBB_API_KEY);

        try {
          showTemporarySuccess('Uploading profile image...');
          const response = await fetch('https://api.imgbb.com/1/upload', {
            method: 'POST',
            body: formData
          });
          const data = await response.json();
          if (!data.success) throw new Error(data.error.message || 'Profile image upload failed');
          profileImg.src = data.data.url;
          await saveProfile();
          showTemporarySuccess('Profile image uploaded and saved');
        } catch (error) {
          console.error('Profile image upload error:', error);
          showTemporaryError(error.message || 'Failed to upload profile image');
          profileImg.src = 'https://via.placeholder.com/64';
        } finally {
          event.target.value = '';
        }
      }

      async function saveProfile() {
        console.log('saveProfile called');
        const newName = newNameInput.value.trim();
        const bio = bioInput.value.trim();
        if (!newName) {
          showTemporaryError('Name cannot be empty');
          return;
        }
        try {
          await updateProfile(auth.currentUser, { displayName: newName });
          await update(ref(db, `usernames/${currentUsername}`), {
            displayName: newName,
            profileImg: profileImg.src,
            bio: bio.slice(0, 150)
          });
          currentDisplayName = newName;
          showTemporarySuccess('Profile updated');
        } catch (error) {
          console.error('Failed to save profile:', error);
          showTemporaryError('Failed to update profile');
        }
      }

      // Chat Functions
      function showPrivateChatList() {
        console.log('showPrivateChatList called');
        privateChatList.classList.remove('hidden');
        privateChatMessages.classList.add('hidden');
        privateMessageInputContainer.classList.add('hidden');
        privateChatTitle.textContent = 'Private Chats';
        privateOnlineStatus.textContent = '';
        privateProfileImg.classList.add('hidden');
        loadPrivateChatList();
      }

      async function loadPrivateChatList() {
        console.log('loadPrivateChatList called');
        privateChatList.innerHTML = '';
        try {
          const userSnap = await get(ref(db, 'usernames'));
          const activeSnap = await get(ref(db, 'activeUsers'));
          const users = userSnap.val() || {};
          const activeUsers = activeSnap.val() || {};

          for (const [username, userData] of Object.entries(users)) {
            if (userData.uid !== currentUser.uid) {
              const isOnline = activeUsers[userData.uid]?.status === 'online';
              const chatItem = document.createElement('div');
              chatItem.className = 'private-chat-list-item flex items-center gap-3 bg-[#FAFAFA] rounded-lg p-3 cursor-pointer hover:bg-[#EFEFEF] shadow-sm';
              chatItem.innerHTML = `
                <img src="${escapeHtml(userData.profileImg || 'https://via.placeholder.com/40')}" alt="Profile" class="profile-img">
                <div class="user-info">
                  <div class="flex items-center gap-2">
                    <h3 class="font-semibold text-[#262626]">${escapeHtml(userData.displayName)}</h3>
                    <span class="status-dot ${isOnline ? 'status-online' : 'status-offline'}"></span>
                  </div>
                  <p class="text-xs text-[#8E8E8E]">@${escapeHtml(username)}</p>
                  <p class="text-xs text-[#8E8E8E] line-clamp-1">${escapeHtml(userData.bio || '')}</p>
                </div>
              `;
              chatItem.addEventListener('click', () => startPrivateChat(userData.uid, userData.displayName, null, userData.profileImg, isOnline ? 'Online' : 'Offline'));
              privateChatList.appendChild(chatItem);
            }
          }
        } catch (error) {
          console.error('Failed to load user list:', error);
          showTemporaryError('Failed to load user list');
        }
      }

      async function startPrivateChat(otherUserId, otherUserName, chatId, profileSrc, status) {
        console.log('startPrivateChat called with:', otherUserName);
        currentChatType = 'private';
        currentChatId = chatId || [currentUser.uid, otherUserId].sort().join('_');
        privateChatList.classList.add('hidden');
        privateChatMessages.classList.remove('hidden');
        privateMessageInputContainer.classList.remove('hidden');
        privateChatTitle.textContent = otherUserName;
        privateProfileImg.src = profileSrc || 'https://via.placeholder.com/40';
        privateProfileImg.classList.remove('hidden');
        privateOnlineStatus.textContent = status;
        privateStartTime = Date.now();
        try {
          await set(ref(db, `privateChats/${currentChatId}/users`), { [currentUser.uid]: true, [otherUserId]: true });
          loadMessages(`privateChats/${currentChatId}/messages`, privateChatMessages);
          updatePinnedMessages(`privateChats/${currentChatId}/messages`, privatePinnedMessages);
          markAllAsRead(`privateChats/${currentChatId}/messages`);
          const privateMessagesRef = ref(db, `privateChats/${currentChatId}/messages`);
          onChildAdded(privateMessagesRef, (snap) => {
            const msg = snap.val();
            if (msg.timestamp > privateStartTime && msg.uid !== currentUser.uid && settings.soundNotifications) {
              receiveSound.play();
            }
          });
        } catch (error) {
          console.error('Failed to start private chat:', error);
          showTemporaryError('Failed to start private chat');
        }
      }

      async function loadMessages(path, container) {
        console.log('loadMessages called for path:', path);
        onValue(ref(db, path), (snapshot) => {
          const wasAtBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 10;
          container.innerHTML = '';
          const data = snapshot.val() || {};
          Object.entries(data).map(([key, value]) => ({ id: key, ...value }))
            .sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0))
            .forEach(msg => addMessage(msg, container));
          if (settings.autoScroll && wasAtBottom) container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
        }, (error) => {
          console.error('Failed to load messages:', error);
          showTemporaryError('Failed to load messages');
        });
      }

      function addMessage(msg, container) {
        const messageDiv = document.createElement('div');
        const isCurrentUser = msg.uid === currentUser.uid;
        messageDiv.className = 'message-appear mb-3';
        messageDiv.dataset.id = msg.id;
        let content = msg.deleted ? '<div class="text-[#8E8E8E] italic text-sm">This message was deleted</div>' : '';
        if (!msg.deleted) {
          if (msg.replyTo) {
            content += `<div class="bg-[#EFEFEF] border-l-4 border-[#C13584] p-2 mb-2 rounded text-xs" id="quoted-${msg.id}"></div>`;
          }
          if (msg.type === 'image') {
            content += `<a href="${escapeHtml(msg.url)}" target="_blank" download class="image-link"><img src="${escapeHtml(msg.url)}" alt="Shared Image" loading="lazy" class="file-message" onerror="this.src='https://via.placeholder.com/150?text=Image+Failed'"></a>`;
          } else {
            content += `<div class="leading-relaxed">${escapeHtml(msg.text)}</div>`;
          }
        }
        let senderHtml = '';
        if (!isCurrentUser) {
          const userData = userCache[msg.username] || {};
          const profileSrc = escapeHtml(userData.profileImg || 'https://via.placeholder.com/40');
          senderHtml = `<div class="flex items-center gap-2 mb-1"><img src="${profileSrc}" alt="Profile" class="w-6 h-6 rounded-full"><div class="text-xs font-semibold text-[#C13584]">${escapeHtml(msg.user)}</div></div>`;
        }
        let timeHtml = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        if (isCurrentUser) {
          const readBy = msg.readBy || {};
          const readCount = Object.keys(readBy).length;
          let totalOther = currentChatType === 'private' ? 1 : Object.values(userCache).filter(u => u.uid !== currentUser.uid).length;
          timeHtml += readCount >= totalOther ? '<span class="ml-1 text-[#C13584]"><i class="fas fa-check-double"></i></span>' : '<span class="ml-1 text-[#8E8E8E]"><i class="fas fa-check"></i></span>';
        }
        messageDiv.innerHTML = `
          <div class="message-bubble ${isCurrentUser ? 'sent' : 'received'} ${msg.deleted ? 'deleted' : ''}">
            ${senderHtml}
            <div class="message-content">${content}</div>
            <div class="text-xs ${isCurrentUser ? 'text-white/70' : 'text-[#8E8E8E]'} mt-1 flex items-center justify-end gap-1">
              ${timeHtml}
            </div>
          </div>
          ${msg.reactions ? `<div class="flex gap-2 mt-1 ${isCurrentUser ? 'justify-end' : 'justify-start'} flex-wrap">${Object.entries(Object.entries(msg.reactions).reduce((acc, [userId, reaction]) => { acc[reaction] = (acc[reaction] || 0) + 1; return acc; }, {})).map(([reaction, count]) => `<span class="reaction-count cursor-pointer" onclick="openReactionModal('${msg.id}')">${reaction} ${count}</span>`).join('')}</div>` : ''}
        `;
        const actionsDiv = document.createElement('div');
        actionsDiv.className = `message-actions ${isCurrentUser ? 'sent' : 'received'}`;
        actionsDiv.innerHTML = `
          <i class="fas fa-reply action-icon" onclick="replyToMessage('${msg.id}', '${escapeHtml(msg.text || '[Image]')}')"></i>
          <i class="fas fa-smile action-icon" onclick="openReactionModal('${msg.id}')"></i>
          <i class="fas fa-thumbtack action-icon" onclick="pinMessage('${msg.id}')"></i>
          ${isCurrentUser && !msg.deleted ? `<i class="fas fa-trash action-icon" onclick="deleteMessage('${msg.id}')"></i>` : ''}
        `;
        messageDiv.appendChild(actionsDiv);
        container.appendChild(messageDiv);
        if (msg.replyTo && !msg.deleted) addQuotedMessage(msg.replyTo, msg.id);
      }

      async function addQuotedMessage(replyToId, currentId) {
        try {
          const snap = await get(ref(db, `${getCurrentPath()}/${replyToId}`));
          const repliedMsg = snap.val();
          if (repliedMsg && !repliedMsg.deleted) {
            const quoteDiv = document.getElementById(`quoted-${currentId}`);
            if (quoteDiv) {
              const text = repliedMsg.type === 'image' ? '[Image]' : repliedMsg.text.substring(0, 50) + (repliedMsg.text.length > 50 ? '...' : '');
              quoteDiv.innerHTML = `<strong>${escapeHtml(repliedMsg.user)}</strong>: ${escapeHtml(text)}`;
            }
          }
        } catch (error) {
          console.error('Error loading quoted message:', error);
        }
      }

      function getCurrentPath() {
        return currentChatType === 'private' ? `privateChats/${currentChatId}/messages` : 'messages';
      }

      window.replyToMessage = function(id, text) {
        console.log('replyToMessage called:', id);
        replyToId = id;
        const replyTextElem = currentChatType === 'group' ? groupReplyText : privateReplyText;
        const replyPreview = currentChatType === 'group' ? groupReplyPreview : privateReplyPreview;
        replyTextElem.textContent = text.length > 50 ? text.substring(0, 50) + '...' : text;
        replyPreview.classList.remove('hidden');
        const input = currentChatType === 'group' ? groupMessageInput : privateMessageInput;
        input.focus();
      }

      window.openReactionModal = function(id) {
        console.log('openReactionModal called:', id);
        reactionMessageId = id;
        reactionModal.classList.remove('hidden');
      }

      window.pinMessage = function(id) {
        console.log('pinMessage called:', id);
        const pinPath = currentChatType === 'private' ? `privateChats/${currentChatId}/pinnedMessages` : 'pinnedMessages';
        get(ref(db, pinPath)).then(snapshot => {
          const pinned = snapshot.val() || {};
          if (Object.keys(pinned).length >= 3) {
            showTemporaryError('Maximum 3 pinned messages allowed');
            return;
          }
          set(ref(db, `${pinPath}/${id}`), true)
            .then(() => showTemporarySuccess('Message pinned'))
            .catch(error => {
              console.error('Failed to pin message:', error);
              showTemporaryError('Failed to pin message');
            });
        });
      }

      window.deleteMessage = function(id) {
        console.log('deleteMessage called:', id);
        if (confirm('Delete this message?')) {
          update(ref(db, `${getCurrentPath()}/${id}`), { deleted: true })
            .then(() => showTemporarySuccess('Message deleted'))
            .catch(error => {
              console.error('Failed to delete message:', error);
              showTemporaryError('Failed to delete message');
            });
        }
      }

      function updatePinnedMessages(path, container) {
        console.log('updatePinnedMessages called for path:', path);
        const pinPath = currentChatType === 'private' ? `privateChats/${currentChatId}/pinnedMessages` : 'pinnedMessages';
        onValue(ref(db, pinPath), (snapshot) => {
          container.innerHTML = '';
          container.classList.add('hidden');
          const pinned = snapshot.val() || {};
          if (Object.keys(pinned).length === 0) return;
          container.classList.remove('hidden');
          Object.keys(pinned).forEach(async (msgId) => {
            const snap = await get(ref(db, `${path}/${msgId}`));
            const msg = snap.val();
            if (msg && !msg.deleted) {
              const pinDiv = document.createElement('div');
              pinDiv.className = 'pinned-message bg-[#EFEFEF] rounded-lg p-2 mb-2 text-sm cursor-pointer';
              pinDiv.innerHTML = `<div class="flex items-center justify-between"><span><strong>${escapeHtml(msg.user)}</strong>: ${escapeHtml(msg.text || '[Image]')}</span><button onclick="unpinMessage('${msgId}')"><i class="fas fa-thumbtack text-[#E1306C] hover:text-[#C13584]"></i></button></div>`;
              pinDiv.addEventListener('click', () => document.querySelector(`[data-id="${msgId}"]`)?.scrollIntoView({ behavior: 'smooth' }));
              container.appendChild(pinDiv);
            }
          });
        }, (error) => {
          console.error('Failed to update pinned messages:', error);
          showTemporaryError('Failed to load pinned messages');
        });
      }

      window.unpinMessage = function(id) {
        console.log('unpinMessage called:', id);
        const pinPath = currentChatType === 'private' ? `privateChats/${currentChatId}/pinnedMessages` : 'pinnedMessages';
        remove(ref(db, `${pinPath}/${id}`))
          .then(() => showTemporarySuccess('Message unpinned'))
          .catch(error => {
            console.error('Failed to unpin message:', error);
            showTemporaryError('Failed to unpin message');
          });
      }

      async function markAllAsRead(path) {
        console.log('markAllAsRead called for path:', path);
        try {
          const snap = await get(ref(db, path));
          const updates = {};
          snap.forEach(child => {
            const msg = child.val();
            const id = child.key;
            if (msg.uid !== currentUser.uid && !msg.readBy?.[currentUser.uid]) {
              updates[`${id}/readBy/${currentUser.uid}`] = serverTimestamp();
            }
          });
          if (Object.keys(updates).length > 0) await update(ref(db, path), updates);
        } catch (error) {
          console.error('Failed to mark messages as read:', error);
        }
      }

      async function sendMessage(type) {
        console.log('sendMessage called, type:', type);
        const input = type === 'group' ? groupMessageInput : privateMessageInput;
        const text = input.value.trim();
        if (!text) return;
        const messageData = {
          uid: currentUser.uid,
          user: currentDisplayName,
          username: currentUsername,
          text,
          timestamp: Date.now(),
          type: 'text',
          replyTo: replyToId || null,
          readBy: {}
        };
        try {
          const path = type === 'private' ? `privateChats/${currentChatId}/messages` : 'messages';
          await push(ref(db, path), messageData);
          input.value = '';
          replyToId = null;
          if (type === 'group') groupReplyPreview.classList.add('hidden');
          else privateReplyPreview.classList.add('hidden');
          if (settings.soundNotifications) sendSound.play();
        } catch (error) {
          console.error('Failed to send message:', error);
          showTemporaryError('Failed to send message');
        }
      }

      async function handleFileUpload(event, type) {
        console.log('handleFileUpload called, type:', type);
        const file = event.target.files[0];
        if (!file) return;
        if (file.size > 32 * 1024 * 1024) {
          showTemporaryError('File size exceeds 32MB limit');
          return;
        }
        if (!file.type.startsWith('image/')) {
          showTemporaryError('Please select an image file');
          return;
        }

        const formData = new FormData();
        formData.append('image', file);
        formData.append('key', IMGBB_API_KEY);

        try {
          showTemporarySuccess('Uploading image...');
          const response = await fetch('https://api.imgbb.com/1/upload', {
            method: 'POST',
            body: formData
          });
          const data = await response.json();
          if (!data.success) throw new Error(data.error.message || 'Image upload failed');
          const messageData = {
            uid: currentUser.uid,
            user: currentDisplayName,
            username: currentUsername,
            url: data.data.url,
            timestamp: Date.now(),
            type: 'image',
            replyTo: replyToId || null,
            readBy: {}
          };
          const path = type === 'private' ? `privateChats/${currentChatId}/messages` : 'messages';
          await push(ref(db, path), messageData);
          replyToId = null;
          if (type === 'group') groupReplyPreview.classList.add('hidden');
          else privateReplyPreview.classList.add('hidden');
          showTemporarySuccess('Image uploaded successfully');
          if (settings.soundNotifications) sendSound.play();
        } catch (error) {
          console.error('Image upload error:', error);
          showTemporaryError(error.message || 'Failed to upload image');
        } finally {
          event.target.value = '';
        }
      }

      function exportChat() {
        console.log('exportChat called');
        get(ref(db, 'messages')).then(snap => {
          let content = '';
          const msgs = Object.entries(snap.val() || {}).sort((a, b) => a[1].timestamp - b[1].timestamp);
          for (const [id, msg] of msgs) {
            content += `[${new Date(msg.timestamp).toLocaleString()}] ${msg.user}: ${msg.text || '[Image: ' + msg.url + ']'}\n`;
          }
          const blob = new Blob([content], { type: 'text/plain' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'group_chat_export.txt';
          a.click();
          URL.revokeObjectURL(url);
          showTemporarySuccess('Chat exported successfully');
        }).catch(error => {
          console.error('Failed to export chat:', error);
          showTemporaryError('Failed to export chat');
        });
      }

      // Event Listeners
      authBtn.addEventListener('click', handleAuth);
      toggleAuth.addEventListener('click', () => {
        console.log('toggleAuth called');
        isSignUp = !isSignUp;
        document.getElementById('nameWrapper').classList.toggle('hidden');
        authBtn.innerHTML = `<i class="fas fa-rocket mr-2"></i>${isSignUp ? 'Create Account' : 'Sign In'}`;
        toggleAuth.textContent = isSignUp ? 'Already have an account? Sign In' : "Don't have an account? Sign Up";
        authMessage.classList.add('hidden');
      });
      googleBtn.addEventListener('click', signInWithGoogle);
      passwordToggle.addEventListener('click', () => {
        console.log('passwordToggle called');
        passwordInput.type = passwordInput.type === 'password' ? 'text' : 'password';
        passwordToggle.className = `fas fa-${passwordInput.type === 'password' ? 'eye' : 'eye-slash'} absolute right-4 top-1/2 transform -translate-y-1/2 text-[#8E8E8E] cursor-pointer hover:text-[#C13584] p-2`;
      });
      resendBtn.addEventListener('click', resendVerification);
      backToLoginBtn.addEventListener('click', backToLogin);
      groupSendBtn.addEventListener('click', () => sendMessage('group'));
      privateSendBtn.addEventListener('click', () => sendMessage('private'));
      groupMessageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage('group');
        }
      });
      privateMessageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage('private');
        }
      });
      groupFileInput.addEventListener('change', (e) => handleFileUpload(e, 'group'));
      privateFileInput.addEventListener('change', (e) => handleFileUpload(e, 'private'));
      profileImgInput.addEventListener('change', handleProfileImgUpload);
      backToPrivateList.addEventListener('click', showPrivateChatList);
      navGroupChat.addEventListener('click', () => switchPage('group'));
      navPrivateChat.addEventListener('click', () => switchPage('private'));
      navSettings.addEventListener('click', () => switchPage('settings'));
      showUsersBtn.addEventListener('click', () => {
        console.log('showUsersBtn called');
        groupSettingsModal.classList.remove('hidden');
        get(ref(db, 'groupInfo')).then(snap => {
          const info = snap.val() || { name: 'Sungabha Group Chat', description: '' };
          groupNameInput.value = info.name;
          groupDescInput.value = info.description;
        }).catch(error => {
          console.error('Failed to load group info:', error);
          showTemporaryError('Failed to load group info');
        });
      });
      saveGroupBtn.addEventListener('click', () => {
        console.log('saveGroupBtn called');
        const name = groupNameInput.value.trim();
        const desc = groupDescInput.value.trim();
        if (!name) {
          showTemporaryError('Group name cannot be empty');
          return;
        }
        set(ref(db, 'groupInfo'), { name, description: desc.slice(0, 200) })
          .then(() => {
            showTemporarySuccess('Group updated');
            document.getElementById('groupChatTitle').textContent = name;
            groupSettingsModal.classList.add('hidden');
          })
          .catch(error => {
            console.error('Failed to save group info:', error);
            showTemporaryError('Failed to update group');
          });
      });
      deleteChatBtn.addEventListener('click', () => {
        console.log('deleteChatBtn called');
        if (confirm('Delete all messages in group chat?')) {
          remove(ref(db, 'messages'))
            .then(() => {
              showTemporarySuccess('Group chat deleted');
              groupSettingsModal.classList.add('hidden');
            })
            .catch(error => {
              console.error('Failed to delete group chat:', error);
              showTemporaryError('Failed to delete group chat');
            });
        }
      });
      exportChatBtn.addEventListener('click', exportChat);
      closeGroupSettingsBtn.addEventListener('click', () => {
        console.log('closeGroupSettingsBtn called');
        groupSettingsModal.classList.add('hidden');
      });
      soundToggle.addEventListener('change', () => {
        console.log('soundToggle changed:', soundToggle.checked);
        settings.soundNotifications = soundToggle.checked;
        localStorage.setItem('chatSettings', JSON.stringify(settings));
      });
      autoScrollToggle.addEventListener('change', () => {
        console.log('autoScrollToggle changed:', autoScrollToggle.checked);
        settings.autoScroll = autoScrollToggle.checked;
        localStorage.setItem('chatSettings', JSON.stringify(settings));
      });
      saveProfileBtn.addEventListener('click', saveProfile);
      logoutBtn.addEventListener('click', () => {
        console.log('logoutBtn called');
        signOut(auth)
          .then(() => showHomeScreen())
          .catch(error => {
            console.error('Logout error:', error);
            showTemporaryError('Failed to logout');
          });
      });
      closeReactionModal.addEventListener('click', () => {
        console.log('closeReactionModal called');
        reactionModal.classList.add('hidden');
      });
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('reaction-btn')) {
          console.log('Reaction button clicked:', e.target.dataset.reaction);
          const reaction = e.target.dataset.reaction;
          if (reactionMessageId && currentUser) {
            set(ref(db, `${getCurrentPath()}/${reactionMessageId}/reactions/${currentUser.uid}`), reaction)
              .then(() => {
                reactionModal.classList.add('hidden');
                reactionMessageId = null;
              })
              .catch(error => {
                console.error('Failed to add reaction:', error);
                showTemporaryError('Failed to add reaction');
              });
          }
        }
      });

      // Auth State Listener
      onAuthStateChanged(auth, (user) => {
        console.log('onAuthStateChanged called:', user ? `User ${user.uid} logged in` : 'No user logged in');
        if (user) {
          if (user.emailVerified) {
            currentUser = user;
            currentDisplayName = user.displayName || user.email.split('@')[0];
            currentUsername = sanitizeUsername(user.email.split('@')[0]);
            showAppContainer();
            const userRef = ref(db, `activeUsers/${currentUser.uid}`);
            set(userRef, {
              name: currentDisplayName,
              username: currentUsername,
              joinedAt: serverTimestamp(),
              status: 'online',
              lastSeen: serverTimestamp()
            });
            onDisconnect(userRef).set({
              name: currentDisplayName,
              username: currentUsername,
              status: 'offline',
              lastSeen: serverTimestamp()
            });
            onValue(ref(db, 'activeUsers'), (snapshot) => {
              document.getElementById('userCount').textContent = Object.values(snapshot.val() || {}).filter(user => user.status === 'online').length;
            });
            onValue(ref(db, 'usernames'), (snap) => {
              userCache = snap.val() || {};
            });
            onValue(ref(db, 'groupInfo'), snap => {
              const info = snap.val();
              if (info) {
                document.getElementById('groupChatTitle').textContent = info.name || 'Sungabha Group Chat';
              }
            });
          } else {
            showVerificationScreen(user.email);
          }
        } else {
          showHomeScreen();
        }
      });
    </script>
</body>
</html>